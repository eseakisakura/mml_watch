　　■ PowerShell / FM Synthesis Chip - Tone Editor 


　当テキストは、構造化エディタで組まれてます。

　-- スクリプト側も構造化エディタに対応しています。--

 
　　□ 概要 


　　FM音源のレジスタ値や音色マトリクス指定を、
　マウスドラッグで変更できるようにしたものです。

　VRC7,OPL,OPN,OPMの各音色マトリクスに対応し、
　変更のち、すぐに試聴できるのが特徴です。


　FM合成波形を視覚的に捉えられ、
　音色づくりに集中できるようにしました。


 
　　□ 注意点について 


　・ppmck,NSDlibのレジスタ記載によるvrc7音色を出力する場合、
　　メニューの切り換えが必要です。

　・mucom,fmp7,mxdrv形式のマトリクス音色出力を選択できますが、
　　内部的には、PMD出力となっています。

　・FM Operator ウィンドウの、各op.のADSRエンベロープ表示は、
　　視覚的に減衰率を捉えたものとなっています。


　・MaskとSSG-EG機能は、opn,opm共用となっています。

　・SSG-EGのエンベロープは、固定表示となってます。


　・FM合成のサイン波表示は、出力波形との擦り合わせを行ったため、
　　近似値は出てますが、完全な再現を目指したものではありません。

　・サイン波形のグラフ表示は、MLの倍数値が高いと誤差が出ます。
　　三角関数多用による演算負荷を軽減するため、float処理しているためです。

　・Multipleが 0.5倍のときは、
　　前半の波形のみ表示し、後半の波形は表示されません。


　・もし起動できない場合は、
　　scriptフォルダのfm_editor.xml環境ファイルを削除して下さい。
　　初期設定と同じになります。



 
　　□ 基本設定 - クイックスタート 


　まず、環境設定から始めます。



　1.　fm_editorを起動し、オプションから settingをクリック、
　　　環境設定が立ち上がります。


　2.　各リストボックスに、必要となるファイル、プログラムを登録します。
　　　binary,player,editor,dosタブに、D&Dで順に登録していきます。
　　　(PMDを64bitOSでの使用の場合、x64にチェックを入れて下さい。)


　3.　再生ボタンを押して、FM変調波の音が出れば基本的な設定は完了です。
　　　もし音が出ない場合は、オプションから、再生できるプレイヤーの選択をしてみて下さい。


 
　　□ 各機能の説明 


	 
　　・メニュー 

　・Preset

　プリセット波形ウィンドウを開きます。


　・Autosave

　vrc7,opl,opn,opmの、最後の状態を保存します。

　(もし起動が不安定の場合、このオプションを外してみて下さい。
　リセット状態での起動となります。)


　・Autosave Parameter

　スライダーのパラメーターをautosave時へ戻します。


　・Reset Parameter

　スライダーのパラメーターを初期状態に戻します。



　・Setting

　　環境設定です。
　　各リストボックスに、ファイルドロップで登録します。



　・4op Mask (PMDのみ対応します)

　試聴時に、オペレータマスクをします。
　チェックオフで、各オペレータをミュートします。


　試聴時に、SSG-EGを使用します。(PMD 4.8s以降のみ)

　ドロップダウンメニューで、EGタイプを選択、
　チェックオンで、各オペレータにSSG-EGをアサインします。
　(4.8r以前のPMDでは、Thruを選択して下さい。)


　・オクターブ

　試聴時のオクターブ指定です。


　・FM OP window

　FM Operator ウィンドウを起動します。


　・2op Type

　nsd, ppmck:reg, nsd:regの形式で表示できます。

　また、表示形式を切り換えることで、
　各形式に対応したインポート、エクスポートもできます。


　・4op Style

　pmd, mucom, fmp7, mxdrvの形式で表示します。
　各形式に対応したインポート、エクスポートも可能です。


　・send

　vrc7からopl変換、opnからopm変換など、データをエクスポートします。


　・Voice

　クリップボードへTextBoxをコピーします。


　・Advanced(上級者向け)

　初期値として読み込まれる、
　試聴用mmlやheaderファイルを、エディタで変更する際、
　使用します。

　"mck_header" "mck_mml" / vrc7 mck
　"nsd_header" "nsd_mml" / vrc7 nsd
　"pmd_header" "pmd_mml" / opl,opn,opm


　・Head reload

　　試聴用mml,headerをエディタで修正した際、
　　これを即時、反映させるためのものです。

　　headerファイル、mmlファイルをリロードします。


 
　　・本体パネルの説明 


　・各種つまみ

　各種パラメータを変更します。


　・FMオペレーター選択 / ロール

　Operator を切り換えます。
　切り換えるごとに、各オペレーターのスライダーを表示します。
　

　・FM音源チップ選択 / ロール

　vrc7,opl,opn,opmを選択します。


　・再生ボタン [ |> ]

　試聴ボタンです。
　"ボタン"にフォーカスあらば、[Space]キーや[Enter]でも試聴再生します。


　・音色ボックス、mmlボックス　インポートボタン [>>]

　テキストボックスの中身を読み込みます。
　マトリクス音色を、直接エディットした際に、インポートするボタンです。

　mmlボックスへ、試聴mmlを流し込んだ際も、このボタンでインポートします。

　("TextBox"にフォーカスあらば、[F5キー]でもインポートします。)
　([F12キー]は、試聴に対応します。)



　・mmlボックス
　厳密な音色エディットなどのため、実際に使用するmmlを流し込んだりできます。
　流し込み後、インポートボタンを押してください。


　・FMマトリクスボックス

　通常は、マトリクス音色データが出力されます。

　外部音色データをインポートする場合は、
　このボックスに流し込み、インポートボタンを押して下さい。
 
　　・Preset波形 ウィンドウ 


　プリセット波形の試聴と、この波形のインポートができます。


　※ セットアップ - PMDプリセット波形データの読込み ------

　PMD98用 Preset FM音色セットをダウンロードします。
　[PMD98_PresetVoices.zip]

　PC88.MML,X68ED.MML,EFFEC.MML
　この3つのファイルを、

　"MC.EXE"があるフォルダに置きます。
　(または、"\mml_watch_gui\script\preset"フォルダへ置く)
　
　プログラムの"起動 or プリセットリロード"時に、各プリセット音色ファイルを読み込みます。


　・リストボックス

　リスト内の、@000などを"クリック"すると、試聴できます。
　(右クリックで、音色データを表示します。)

　・インポートボタン

　インポートボタンを押すと、FM波形エディタへ読み込みます。





 
　　・Operator Mask ウィンドウ 


　4op時、各オペレーターのマスクやSSG-EGを切り替えます。


　・Mask

　チェックoffで、オペレーター出力を停止します。


　・SSG-EG

　チェックonで、SSGエンベロープを使用できます。
　([OPN]のみ可。)

　ドロップダウンメニューから、SSGエンベロープフィルターを選択します。
　(PMD ver.4.8s以降であれば、適用できます。)

　SSG-EGを解除する場合、op.ごとにSE15,0などを発行する必要があります。

　(解除するop.へチェック入れて、0で再生する。
    -> op.1であれば、SE1,0が発行される。)
 
　　・FM Operator ウィンドウ 


　FM変調波形、ADSRエンベロープを視覚的に見せるウィンドウです。


　各オペレータを"Click"して、エディットするOp.を選択します。
　([ドラッグ移動] or [ホイール]で、valueの調整)
　([右クリック]から、valueの選択も可)

　背景を"Click"すると、試聴再生します。
　([右クリック]は、オクターブ選択)
　([ホイール]で、アルゴリズムの変更)

　"ウィンドウ自体"にフォーカスあらば、[Space]キーや[Enter]でも試聴再生します。


　・Property

　FM波形の精度を決めます。

　1/2精度では、サンプルポイントは 2px単位 80point表示となります。


　・Adjust

　Sine波形のグラフ出力調整です。
　音声感覚と視覚のズレを、擦り合わせるためのものです。

　モジュレーションからキャリアへの、モジュレートレベルの変更、
　及び、フィードバックレベルの変更を行います。

　(通常は、default値の20となります。)


　・Wait

　　Sine波形表示までのウェイトです。
　　1/1精度などの負荷が重い時、レスポンスの遅延タイムの指定をします。


  
　　□ Tips 


	 
　・楽器ごとのアルゴリズム選択の目安 


　0: ディストーションギター、チョッパーベース、ハイハット
　1: ハープ、PSG(programmable sound generator)
　2: ピアノ、ブラス、エレクトリックギター、ベース、ウッド
　3: ストリングス、チャイム、フォークギター
　4: コーラス、フルート、ベル、パスドラム、スネアドラム、タムタム
　5: ブラス、オルガン
　6: オルガン、シロホン、ビブラホン、ベースドラム、スネアドラム、タムタム
　7: パイプオルガン




 
　・2opでのBassの音づくり 


　モジュレーションのマルチプルを0 (1/2波長)とし、
　トータルレベルを必要なだけ上げます。(15ぐらい)

　キャリアのマルチプルを上げて、(3くらい)必要となるハイトーンを足します。
　フィードバックで、エレクトリックベース感を足します。(4くらい)

　(キャリアで音量を決め、モジュレーションで音づくりが基本です。)



 
　・4opにおける、3op+ 1opでの楽器波形の再現例 


　アルゴリズム2を使用します。
　主にop2とop3で音色となる倍音成分をつくります。

　op3のトータルレベルは、40とします。
　op2のトータルレベルを上げ、必要となる倍音成分を足します。

　op1とフィードバックを使い、波形全体をねじ曲げ、
　実音のサンプル波形に近づけます。


　モジュレーターのマルチプルの値は、キャリアに対して、
　1,3,5 : 1, 整数倍音(ノコギリ波)、2,4,6 : 1, 奇数倍音(矩形波)を意識することで、
　より楽器の音色に近づいていきます。




 
　・既存の音色データを使用して音づくりしたい 


　テキストボックスから、設定値を取り込むことができます。

　テキストボックスに、FM音色マトリクスを流し込み、
　音色データインポートボタンを押して下さい。


　4op style変更により、FMP7,MUCOM, MXDRV 各形式のインポートに対応します。
　出力された並べ順と同じ配置の入力値であれば、
　この形で、インポートします。

　読み込む際、音色データ形式のカウント数をチェックします。
　(opnで、42[10*4+2]、opmの場合、46[11*4+2]です)


　正規表現(?<=^|;|:|,|\s)(?:-)?[0-9]+?(?=;|:|,|\s|\n|$)として、
　数値列を読み込む仕様です。

　(読み込み失敗は、必要な数値の前にスペースがないケースが多いです。)


　---- インポート例 ----

　opn / 4op style: PMD

  @100   5   5 # フィードバックベース[opn,o2]
    NM ALG  FB
 012 008 007 005 010 014 000 000 000 000
  21, 18, 10, 05, 08, 19, 00, 00, 00, 00,
  24, 12, 11,  5,  7, 20,  0,  3,  0,  0,
  19   6  18   5   7   0   0   5   0   0
  AR  DR  SR  RR  SL  TL  KS  ML  DT AMS

　---- ----

  
　　□ 仕様について 

　音色指定のマイナス値は 0に変換されます。

　(opn,opmのDT1 のvalueは、0 - 7の範囲で指定して下さい。
　テキストボックス内で、-3 指定を行うと、
　-3 の値は 0に変換されます。)


　op.グラフのサイン波は、精度を下げると
　プレイヤーの再生波形に比べ歪みが、強く表示される傾向があります。


　プレイヤー側に線形補完や、ローパスフィルタが入っているケースでは、
　エディタ側波形出力に比べ、幾分違いが出ます。

　(フィードバックが、フィルタ発振の状態であっても、
　プレイヤー側での波形補完が入ると、波形出力が穏やかになることが分かってます。)
　[1/1 精度のグラフ時、PMDWin.dll側の線形補完を外すと近似値が出る。]


　以下、計算式の概略となります。

　https://eseakisakura.wordpress.com/2022/01/31/fm-powershell-0/
　詳しくは、こちらで解説しています。


　---- デシベルから電圧・音圧比への変換式
　V2/V1 = 10^(A/20)
　v2= 10^(a/20)* v1
　v2= 10^(-0.75dB* TL/ 20)* v1
　TL: トータルレベル

　--- 直列接続での、FM変調の計算式
　F(t)= A(t)* sin(Wct+ ( I(t)* sinWmt) )
　W: 角速度オメガ
　c:キャリア
　m:モジュレーション

　--- フィードバックの計算式
　F1(t)=  I(t)* sin( Wmt+B F1(t) )
　W: 角速度オメガ
　B: 帰還率ベータ
 
　　□ 謝辞 / 参照リンク 


　以下のページ様のデータを参照しています。

　・Mck wiki / 波形定義 - vrc7の音色例
　　https://wikiwiki.jp/mck/


　・P.M.D [自作ツールのお部屋] - (PMD98用 Preset FM音色セット) / KAJA 様
　　http://www5.airnet.ne.jp/kajapon/


　・Val sound FM-Sound Library / Takeshi Abo様
　　http://www.valsound.com/


 
　　□ 免責事項 /使用条件 /著作権など 


　・Apacheライセンス2.0を適用して下さい

　・当スクリプト群を使用して何らかの問題が起こっても、責任を要求しないこと
　・再配布する際は、当ドキュメントファイルを維持して下さい


　= 黄白紅藍玄 =
　https://twitter.com/huangbaihonglan

　Copyright(C) 04coreworks
　https://github.com/eseakisakura


'19	2 28		F12キーで試聴できるようにした
	3 14		Operator windowを追加した
			別windowをshowdialogからshow/hideにした

	7 5		試聴mmlをheaderフォルダから読むようにした
			op2,3,4でもalg,fbを変えられるようにした

	8 5		2op時のwindowサイズを小さくした、描画のチラツキ少なくした
	10		サインカーブ計算の訂正

	11 17	テキストボックスからのインポートに対応した
			All_szをstring配列の読み込みにした
			描画レジューム位置の最適化をした

	22		sin波の合成時に、モジュレート調整ができるようにした
			sl値が逆だったので修正した
			描画修正時、必要となるall_chg抜けを直した
			プラグイン呼び出し対応のため、global:からscript:へ変更した

	26		フィードバックの構文を直した
			実測値に近いモジュレート出力に変更した
			グローバル変数を全て一か所に集めた

	28		x軸の色を黒からそれぞれのopに対応させた
			イベントにtry catch構文を加えた

	29		Op windowのマウスクリックでop,algを変更できるようにした

	12  1	サイン、エンベロープの座標のdot位置修正
			op2エンベロープのeg on時、計算間違い訂正
			カレントopに枠を付けた
	2		カラーobj減らし起動を速くした
			lightカラーの再調整
	5		if("") -> if('')と直した
	7		win10対応のため、eventスクリプトブロック内に$script:を挿入した
			win10対応のため、hash,xmlの左辺、script:スコープを見直した
			funcの引数を$x= $script:^^^として、funcへローカル登録とした
	16		contxt menuをチェック付きにした
	25		音色出力にゼロ埋めとアステリスクを付けられるようにした
	27		mmlwatchから呼び出し時、select機能の間違いを修正

'20	1 10		2opのEGT表現の間違いを修正
	12		Advancedで試聴mmlを呼び出せるようにした
			preset音色追加
	16		Undoバッファ追加
	18		4opFM音色styleごとに入出力できるようにした
	22		vrc7のtype別レジスタ値を入出力できるようにした
	24		$0問題のため、-replaceを.Replaceへ変更、
			mckを試聴できるようにした
			Change_menuの-matchを.Containsへ変更
	31		GUI対応のエラー出力にした

	2 3		layout変更できるようにしたため、Chip_positionの追加
	2 5		必要となるUnredo 2の追加、mainのautosave読み出し修正、
			PointObjとしてfunc化、$boxs["wait"] valueを1,2,4へ変更
			Boxs_readでバラバラの変数をハッシュ化した
	2 8		遅延が出ていた$fm_boxを最適化した、Undoをobjにして高速化した
	27		autoloadの引数抜けと、$x.nameの$抜けエラー修正
			_vrcの空配列をコピーして使うようにした
			スタンドアロンにした、環境設定を自前でできるようにした。
	3 1		autosave機能のon,offをできるようにした
			autosaveを2opや4opそれぞれ別々に記録するようにした
	5		インポート時のカウントチェックを厳密にした
	22		Op.maskウィンドウを追加した
	23		SSG-EGを指定できるようにした
	26		2.0以降のため、ClosingからFormClosingへ変更
	4 1		SSG-EGに固定エンベロープを付けた
	3		maskとSSG-EGの状態をマトリクスにコメント出力するようにした

	7 25		menu_buildの失敗点、ハッシュの初期化、メニューのリセットを修正
	8 17		vrc7,PC88.MML,X68ED.MML,EFFEC.MML音色データを、presetとして読めるようにした
	  29		trayiconを追加、状態チェック付き最小化とした
	11 26	HelpファイルをStedで読めるようにした

'21	1 12		main時、AutoloadでのPanel_chgの2重読み込みを修正
			opチェンジ時、フロントパネルカラーを変更するようにした
			再生時、黒丸、エクスポート時プラム丸が表示されるようにした
	17		精度をいつでも切り換えられるようにした
			この際、Sin_positionの空配列確保の致命的ミスを修正
			PictBoxを2opと4opを分離した。切り換え時の見た目アップ。
			feedbackを仕様通り、2sampleと変え、adjは20辺りとした
	21		trayicon非表示機能つけた
			PS7ため、ps1と読み込みfileはutf8(appためbom有り)とした(mml出入力はshiftJISのまま)
			mmlライタをcommon.ps1へ移動した(utf8 bom無しへ対応するため)

	2 1		[cat]ファイル読み込み回数をできるだけ減らした
	5		presetを選択すると、OPwindowが連動して変化するようにした
			Autoload、Panel_chg周りを修正
	25		Preset時、4opスタイルは保持へ直し、textboxはグレイ化とした
			Mask thruで、SE15,0を発行するに変えた、boxheader周り修正
			mucomスタイルを追加した
	3 6		compiler周りの読み込み方を変えた。

	6 21		サスティンレベルの間違い、0max-15minへ全て修正した
	6 25		プレイヤーオープンを実装した
	9 4		bug fix - header+MMLのtrue,false間違い
	10		Reg_exp,Fmx_expのerr popup部修正

	11 25	初動からの安定性を上げた、Change_value周りの最適化
	12 3		$fm_menu_type_mckreg.Add_Click周りのイベントコンパイラ選択bugfix
			Presetのtab変更時のイベントコンパイラ選択bugfix
	17		初動時のPreset_readエラーによる処理落ちbugfix

'22	1 11		send機能を付けた
	24		セーブ時、Operator numberを記録するようにした

	5 5		メニューのpreset load時、エラーあらば表示するようにした
			電圧定数のテストしたままを元にもどした

	11 13	ps7対応のため、パーツの座標を修正した。
	16	コンパイラメニュー部を直した。

	12 29	op windowの画像出力側から、ホイールで値を変更できるようにした。
			op.bg.の右クリックメニューを変更した。
			各FM oscで、最後のop.位置を独立懸架とした。
			各FM oscで、value選択は独立懸架とした。

	30		op windowへの、ドラッグ移動でも値を変更できるようにした。

'23	1 4		pictboxの選択は、ホバーで移動できるようにした。
			op.マスクの出力ミスと、SSG-EGはOPNのみ、掛かるように修正。
	6		ADSRコピーが、できるようにした。

	2 6		TrackBarコントロールを、マウスによるドラッグ回転つまみに変えた。
			ダークモードとライトモードを実装した。
			mml窓を追加した。
			Presetから直接エディット、インポートできるよう、コンバートボタンによる
			overwriteの手順を変更した。

	9		op.windowの解像度をx軸160pointから320pointへ上げ、倍精度表示できるようにした。
			$imgをグローバルから、各関数ローカルへ移動した。

			op.windowへsin波の書き込み時、アンチエイリアスが適用できるよう、
			buffer描画からgrp描画へ変更した。BGも同様の変更をした。

			Presetで、ClickToPlayの選択ができるようにした。
 	
